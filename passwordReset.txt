<?php
include 'header.php';

// Check if the resetEmail session key is set
if (isset($_SESSION['resetEmail'])) {
    $resetEmail = $_SESSION['resetEmail'];

    if (isset($_SESSION['resetTime'])) {
        $resetTime = strtotime($_SESSION['resetTime']); // Convert session time to Unix timestamp

        // Check if the reset key is valid within the 15-minute timeframe
        $currentTime = time(); // Current time in seconds
        $validTime = 15 * 60; // 15 minutes in seconds

        if (($currentTime - $resetTime) <= $validTime) {
            // Continue with the password reset process

            // Calculate time left
            $timeLeft = $validTime - ($currentTime - $resetTime);

            // Display the countdown timer
            echo '
            <style>
                .strength-status {
                    font-weight: bold;
                    margin-top: 10px;
                }

                .weak {
                    color: red;
                }

                .normal {
                    color: orange;
                }

                .strong {
                    color: green;
                }
            </style>

            <body class="home">
                <form action="resetPass.php" method="post">
                    <label> Enter Password Reset Key We Sent to (' . $resetEmail . ')</label> 
                    <input type="text" name="resetKey" id="resetKey" required> 
                    (Time left to key expiration: <span id="timer"></span>)
                    <br> 
                    <label> New Password</label>
                    <input type="password" name="newPass" id="newPass" required>
                    <div class="strength-status" id="strength-status"></div>
                    <label> Confirm New Password</label>
                    <input type="password" name="confirmPass" id="confirmPass" required>
                    <br>

                    <input type="submit" value="Enter">  
                    <br> <br> 
                    <p> REMEMBER :- 
                        <small> * Password Reset Key is valid until 15 minutes.<br> * If time exceeds, you must request another key.<br> * You can request a maximum of 3 keys per day.<br> * If you fail 6 attempts in a row to enter the correct Password key, your account will be deactivated.</small>
                    </p> 
                </form>

                <!-- JavaScript -->
                <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
                <script src="assets/vendors/jquery/jquery.js"></script>
                <script src="assets/vendors/waypoint/jquery.waypoints.min.js"></script>
                <script src="assets/vendors/bootstrap/js/bootstrap.min.js"></script>
                <script src="assets/vendors/jquery-ui/jquery-ui.min.js"></script>
                <script src="assets/vendors/progressbar-fill-visible/js/progressBar.min.js"></script>
                <script src="assets/vendors/countdown-date-loop-counter/loopcounter.js"></script>
                <script src="assets/vendors/counterup/jquery.counterup.js"></script>
                <script src="assets/vendors/modal-video/jquery-modal-video.min.js"></script>
                <script src="assets/vendors/masonry/masonry.pkgd.min.js"></script>
                <script src="assets/vendors/fancybox/dist/jquery.fancybox.min.js"></script>
                <script src="assets/vendors/slick/slick.min.js"></script>
                <script src="assets/vendors/slick-nav/jquery.slicknav.js"></script>
                <script src="assets/js/custom.js"></script>
                <script src="assets/js/guard.js"></script>
                <script>
                    // On page load or when changing themes, best to add inline in `head` to avoid FOUC
                    if (localStorage.getItem("theme-color") === "dark" || (!("theme-color" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
                        document.getElementById("light--to-dark-button")?.classList.add("dark--mode");
                    } 
                    if (localStorage.getItem("theme-color") === "light") {
                        document.getElementById("light--to-dark-button")?.classList.remove("dark--mode");
                    } 

                    // Countdown timer script
                    var timeLeft = ' . $timeLeft . ';
                    function updateTimer() {
                        var minutes = Math.floor(timeLeft / 60);
                        var seconds = timeLeft % 60;
                        document.getElementById("timer").innerHTML = minutes + "m " + seconds + "s";
                        if (timeLeft > 0) {
                            timeLeft--;
                            setTimeout(updateTimer, 1000);
                        } else {
                            alert("The password reset key has expired. Please request a new key.");
                            window.location.href = "login.php";
                        }
                    }
                    updateTimer();
                </script>
            </body>
            </html>';
        } else {
            // The reset key has expired, inform the user and redirect
            echo '<script>alert("The password reset key has expired. Please request a new key.");</script>';
            header("Location: login.php");
            exit();
        }
    } else {
        // The required session keys are not set, inform the user and redirect
        echo '<script>alert("Invalid request. Please request a password reset key first.");</script>';
        header("Location: login.php");
        exit();
    }
} else {
    // Redirect to the login page or handle the case where the session key is not set
    header("Location: login.php");
    exit();
}
?>
